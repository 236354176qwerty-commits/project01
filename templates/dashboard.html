{% extends "base.html" %}

{% block title %}ä¸ªäººèµ„æ–™ - æ­¦æœ¯èµ›äº‹ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- æ¬¢è¿åŒºåŸŸ -->
<div class="welcome-section mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="h3 mb-2">
                <i class="fas fa-tachometer-alt me-2"></i>
                æ¬¢è¿å›æ¥ï¼Œ{{ current_user }}ï¼
            </h1>
            <p class="text-white mb-0">
                å½“å‰èº«ä»½ï¼š
                <span class="role-badge ms-1 {% if user_role == 'super_admin' %}super-admin{% elif user_role == 'admin' %}admin{% elif user_role == 'judge' %}judge{% else %}user{% endif %}">
                    {% if user_role == 'super_admin' %}è¶…çº§ç®¡ç†å‘˜
                    {% elif user_role == 'admin' %}ç®¡ç†å‘˜
                    {% elif user_role == 'judge' %}è£åˆ¤
                    {% else %}æ™®é€šç”¨æˆ·
                    {% endif %}
                </span>
                | ä»Šå¤©æ˜¯ <span id="current-date"></span>
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                </button>
                {% if user_role in ['admin', 'super_admin'] %}
                <button type="button" class="btn btn-primary" onclick="showQuickCreateEventModal()">
                    <i class="fas fa-plus me-1"></i>åˆ›å»ºèµ›äº‹
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
<div class="row g-4">
    <!-- å·¦ä¾§å†…å®¹ -->
    <div class="col-lg-8">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <a href="{{ url_for('results') }}" class="text-decoration-none">
                    <div class="stat-card card border-0 shadow-sm hover-lift">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon rounded-circle me-3 text-white" style="background-color: {% if user_role == 'super_admin' %}#dc2626{% elif user_role == 'admin' %}#d97706{% elif user_role == 'judge' %}#059669{% else %}#2563eb{% endif %};">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-1" id="my-scores-count">-</h5>
                                    <p class="card-text text-muted small mb-0">é€šçŸ¥å…¬å‘ŠæŸ¥è¯¢</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            
            <div class="col-md-6">
                <a href="javascript:void(0)" onclick="viewNotifications()" class="text-decoration-none">
                    <div class="stat-card card border-0 shadow-sm hover-lift">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="stat-icon bg-info text-white rounded-circle me-3">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-1" id="notifications-count">-</h5>
                                    <p class="card-text text-muted small mb-0">å¾…å¤„ç†é€šçŸ¥</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <!-- æˆ‘çš„èµ›ç¨‹å®‰æ’ -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-check me-2"></i>æˆ‘çš„èµ›ç¨‹å®‰æ’
                </h5>
                <button class="btn btn-sm btn-primary" onclick="loadMySchedule()">
                    <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                </button>
            </div>
            <div class="card-body">
                <div id="my-schedule" class="schedule-list">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½èµ›ç¨‹ä¿¡æ¯...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§è¾¹æ  -->
    <div class="col-lg-4">
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>å¿«é€Ÿæ“ä½œ
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if user_role in ['admin', 'super_admin'] %}
                    <button class="btn btn-primary" onclick="showQuickCreateEventModal()">
                        <i class="fas fa-plus me-2"></i>åˆ›å»ºèµ›äº‹
                    </button>
                    {% endif %}
                    {% if user_role == 'super_admin' %}
                    <button class="btn btn-outline-primary" onclick="window.location.href='/send_notification'">
                        <i class="fas fa-paper-plane me-2"></i>å‘é€é€šçŸ¥
                    </button>
                    {% endif %}
                    {% if user_role in ['admin', 'super_admin'] %}
                    <button class="btn btn-outline-primary" onclick="manageParticipants()">
                        <i class="fas fa-users me-2"></i>ç®¡ç†å‚èµ›è€…
                    </button>
                    {% endif %}
                    
                    <button class="btn btn-outline-success" onclick="registerForEvent()">
                        <i class="fas fa-user-plus me-2"></i>æŠ¥åå‚èµ›
                    </button>
                    
                    {% if user_role in ['judge', 'admin', 'super_admin'] %}
                    <button class="btn btn-outline-warning" onclick="startScoring()">
                        <i class="fas fa-star me-2"></i>å¼€å§‹è¯„åˆ†
                    </button>
                    {% endif %}
                    
                    <button class="btn btn-outline-info" onclick="viewResults()">
                        <i class="fas fa-chart-bar me-2"></i>æŸ¥çœ‹æˆç»©
                    </button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ - ä»…ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯è§ -->
        {% if user_role in ['admin', 'super_admin'] %}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>ç³»ç»ŸçŠ¶æ€
                </h5>
            </div>
            <div class="card-body">
                <div class="status-item d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">æ•°æ®åº“è¿æ¥</span>
                    <span class="badge bg-success">æ­£å¸¸</span>
                </div>
                <div class="status-item d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">æœåŠ¡å™¨çŠ¶æ€</span>
                    <span class="badge bg-success">è¿è¡Œä¸­</span>
                </div>
                <div class="status-item d-flex justify-content-between align-items-center">
                    <span class="text-muted">æœ€åæ›´æ–°</span>
                    <span class="text-muted small" id="last-update">-</span>
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿç»´æŠ¤ - ä»…ç®¡ç†å‘˜å’Œè¶…çº§ç®¡ç†å‘˜å¯è§ -->
        <div class="card border-0 shadow-sm mt-3">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2 text-primary"></i>ç³»ç»Ÿç»´æŠ¤
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button id="maintenanceModeBtn" class="btn btn-warning" onclick="toggleMaintenanceMode()">
                        <i class="fas fa-tools me-2"></i><span id="maintenanceBtnText">è¿›è¡Œç³»ç»Ÿç»´æŠ¤</span>
                    </button>
                </div>
                <div class="mt-3 pt-2 border-top">
                    <small class="text-muted" id="maintenanceStatus">
                        <i class="fas fa-info-circle me-1"></i>å½“å‰çŠ¶æ€: <span id="maintenanceStatusText">æ­£å¸¸è¿è¡Œ</span>
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- å¼•å…¥å…±ç”¨çš„åˆ›å»ºèµ›äº‹æ¨¡æ€æ¡† -->
{% include 'components/create_event_modal.html' %}

<!-- èµ›äº‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailTitle">èµ›äº‹è¯¦æƒ…</h5>
                <button type="button" class="btn-close" onclick="closeEventModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventDetailContent">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEventModal()">å…³é—­</button>
                <div id="eventDetailActions">
                    <!-- æ“ä½œæŒ‰é’®å°†æ ¹æ®æƒé™åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* å¡ç‰‡hoveræ•ˆæœ */
.hover-lift {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.hover-lift:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
}

a:hover .hover-lift {
    transform: translateY(-5px);
}

/* èµ›äº‹è¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼ä¼˜åŒ– */
#eventDetailModal {
    z-index: 9999 !important;
}

#eventDetailModal.show {
    display: block !important;
}

#eventDetailModal .modal-dialog {
    max-width: 800px;
    z-index: 10000 !important;
    position: relative;
}

#eventDetailModal .modal-content {
    position: relative;
    z-index: 10001 !important;
}

#eventDetailModal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
    padding: 1.5rem;
}

/* æ ¸å¿ƒä¿¡æ¯è¡¨æ ¼æ ·å¼ */
#eventDetailModal .core-info .table {
    margin-bottom: 0;
    font-size: 1rem;
}

#eventDetailModal .core-info .table td {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

#eventDetailModal .core-info .table tbody tr:last-child td {
    border-bottom: none;
}

#eventDetailModal .core-info .table tbody tr:hover {
    background-color: #f8f9fa;
}

/* æè¿°ä¿¡æ¯æ ·å¼ */
#eventDetailModal .description-info h6 {
    color: #2c3e50;
    font-weight: 600;
}

/* éšè—èƒŒæ™¯é®ç½© */
.modal-backdrop {
    display: none !important;
}

/* æ¨¡æ€æ¡†å®šä½å’Œæ ·å¼ */
#eventDetailModal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    outline: 0 !important;
    pointer-events: none !important; /* å…è®¸ç‚¹å‡»ç©¿é€åˆ°ä¸‹æ–¹ */
}

#eventDetailModal .modal-dialog {
    pointer-events: auto !important; /* æ¨¡æ€æ¡†æœ¬èº«å¯ç‚¹å‡» */
}

/* ä¸ºæ¨¡æ€æ¡†æ·»åŠ é˜´å½±ï¼Œä½¿å…¶åœ¨æ²¡æœ‰èƒŒæ™¯çš„æƒ…å†µä¸‹æ›´çªå‡º */
#eventDetailModal .modal-content {
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;
    border: 1px solid rgba(0, 0, 0, 0.2) !important;
}
</style>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/event_modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/event_fees.js') }}"></script>
<script>
// æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰èµ›äº‹æ•°æ®
function checkEvents() {
    console.log('==================== æ£€æŸ¥èµ›äº‹æ•°æ® ====================');
    
    $.ajax({
        url: '/api/events/',
        method: 'GET',
        success: function(response) {
            console.log('âœ… èµ›äº‹åˆ—è¡¨APIæˆåŠŸ');
            if (response.success && response.events) {
                console.log('æ•°æ®åº“ä¸­çš„èµ›äº‹æ€»æ•°:', response.events.length);
                console.log('å‰3ä¸ªèµ›äº‹:', response.events.slice(0, 3));
                
                if (response.events.length > 0) {
                    alert('âœ… æ•°æ®åº“æœ‰èµ›äº‹æ•°æ®\n\næ€»æ•°: ' + response.events.length + '\nç¬¬ä¸€ä¸ªèµ›äº‹: ' + response.events[0].name);
                } else {
                    alert('âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰ä»»ä½•èµ›äº‹ï¼\nè¯·å…ˆåœ¨"èµ›äº‹ç®¡ç†"ä¸­åˆ›å»ºèµ›äº‹ã€‚');
                }
            }
        },
        error: function(xhr) {
            console.error('âŒ è·å–èµ›äº‹åˆ—è¡¨å¤±è´¥:', xhr.status);
            alert('âŒ æ— æ³•è®¿é—®èµ›äº‹åˆ—è¡¨API\nçŠ¶æ€ç : ' + xhr.status);
        }
    });
}

// æµ‹è¯•APIè¿æ¥
function testAPI() {
    console.log('==================== æµ‹è¯•APIè¿æ¥ ====================');
    
    // 1. æµ‹è¯•è·å–èµ›ç¨‹åˆ—è¡¨
    $.ajax({
        url: '/api/dashboard/my-schedule',
        method: 'GET',
        success: function(response) {
            console.log('âœ… èµ›ç¨‹APIè°ƒç”¨æˆåŠŸ!');
            console.log('å®Œæ•´èµ›ç¨‹æ•°æ®:', response);
            
            if (response.success && response.schedules && response.schedules.length > 0) {
                const firstEvent = response.schedules[0];
                console.log('==================== èµ›ç¨‹è¯¦æƒ… ====================');
                console.log('èµ›ç¨‹æ•°é‡:', response.schedules.length);
                console.log('ç¬¬ä¸€ä¸ªèµ›äº‹å®Œæ•´æ•°æ®:', firstEvent);
                console.log('èµ›äº‹ID:', firstEvent.id);
                console.log('èµ›äº‹IDç±»å‹:', typeof firstEvent.id);
                console.log('èµ›äº‹åç§°:', firstEvent.name);
                
                // 2. æµ‹è¯•è·å–èµ›äº‹è¯¦æƒ…
                const eventId = firstEvent.id;
                const apiUrl = `/api/events/${eventId}`;
                console.log('==================== æµ‹è¯•èµ›äº‹è¯¦æƒ…API ====================');
                console.log('è¯·æ±‚URL:', apiUrl);
                
                $.ajax({
                    url: apiUrl,
                    method: 'GET',
                    success: function(detailResponse) {
                        console.log('âœ… èµ›äº‹è¯¦æƒ…APIè°ƒç”¨æˆåŠŸ!');
                        console.log('è¯¦æƒ…æ•°æ®:', detailResponse);
                        
                        if (detailResponse.success) {
                            alert('âœ… APIæµ‹è¯•æˆåŠŸï¼\n\nèµ›äº‹åç§°: ' + detailResponse.event.name + '\nèµ›äº‹ID: ' + eventId + '\n\nå¯ä»¥ç‚¹å‡»é¡µé¢ä¸Šçš„è¯¦æƒ…æŒ‰é’®äº†ï¼');
                        } else {
                            alert('âŒ APIè¿”å›å¤±è´¥: ' + detailResponse.message);
                        }
                    },
                    error: function(xhr) {
                        console.error('âŒ èµ›äº‹è¯¦æƒ…APIè°ƒç”¨å¤±è´¥!');
                        console.error('è¯·æ±‚URL:', apiUrl);
                        console.error('çŠ¶æ€ç :', xhr.status);
                        console.error('å“åº”æ–‡æœ¬:', xhr.responseText);
                        
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            console.error('é”™è¯¯è¯¦æƒ…:', errorData);
                        } catch(e) {
                            console.error('æ— æ³•è§£æé”™è¯¯å“åº”');
                        }
                        
                        alert('âŒ èµ›äº‹è¯¦æƒ…APIå¤±è´¥ï¼\n\n' +
                              'çŠ¶æ€ç : ' + xhr.status + '\n' +
                              'èµ›äº‹ID: ' + eventId + '\n' +
                              'URL: ' + apiUrl + '\n\n' +
                              'å¯èƒ½åŸå› ï¼š\n' +
                              '1. èµ›äº‹åœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨\n' +
                              '2. APIè·¯ç”±æœªæ­£ç¡®é…ç½®\n' +
                              '3. æƒé™ä¸è¶³\n\n' +
                              'å»ºè®®ï¼šè¿è¡Œ checkEvents() æ£€æŸ¥æ•°æ®åº“');
                    }
                });
            } else {
                alert('âš ï¸ æ²¡æœ‰èµ›ç¨‹æ•°æ®ï¼\n\næ‚¨è¿˜æ²¡æœ‰å‚åŠ ä»»ä½•èµ›äº‹ã€‚\nè¯·å…ˆå»"èµ›äº‹å¤§å…¨"é¡µé¢æŠ¥åå‚èµ›ã€‚');
            }
        },
        error: function(xhr) {
            console.error('âŒ èµ›ç¨‹APIè°ƒç”¨å¤±è´¥!');
            console.error('çŠ¶æ€ç :', xhr.status);
            console.error('å“åº”:', xhr.responseText);
            alert('âŒ èµ›ç¨‹APIå¤±è´¥\nçŠ¶æ€ç : ' + xhr.status + '\n\nå¯èƒ½æ˜¯æœªç™»å½•æˆ–sessionè¿‡æœŸ');
        }
    });
}

// æµ‹è¯•æ¨¡æ€æ¡†æ˜¾ç¤ºåŠŸèƒ½
function testModal() {
    console.log('=== å¼€å§‹æµ‹è¯•æ¨¡æ€æ¡† ===');
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    const modalEl = document.getElementById('eventDetailModal');
    console.log('1. æ¨¡æ€æ¡†å…ƒç´ å­˜åœ¨:', !!modalEl);
    
    // æ£€æŸ¥jQueryæ˜¯å¦åŠ è½½
    console.log('2. jQueryå·²åŠ è½½:', typeof jQuery !== 'undefined');
    
    // æ£€æŸ¥Bootstrapæ˜¯å¦åŠ è½½
    console.log('3. Bootstrapå·²åŠ è½½:', typeof bootstrap !== 'undefined');
    
    if (!modalEl) {
        alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ¨¡æ€æ¡†å…ƒç´ ï¼è¯·åˆ·æ–°é¡µé¢ã€‚');
        return;
    }
    
    // è®¾ç½®æµ‹è¯•å†…å®¹
    $('#eventDetailTitle').text('æµ‹è¯•èµ›äº‹');
    $('#eventDetailContent').html('<p class="text-center py-5">è¿™æ˜¯æµ‹è¯•å†…å®¹ï¼Œå¦‚æœèƒ½çœ‹åˆ°è¿™ä¸ªè¯´æ˜æ¨¡æ€æ¡†å¯ä»¥æ­£å¸¸æ˜¾ç¤ºã€‚</p>');
    $('#eventDetailActions').html('');
    
    // å°è¯•æ˜¾ç¤º
    try {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        console.log('4. æ¨¡æ€æ¡†æ˜¾ç¤ºæˆåŠŸï¼');
        alert('æ¨¡æ€æ¡†æµ‹è¯•æˆåŠŸï¼å¦‚æœä½ èƒ½çœ‹åˆ°æ¨¡æ€æ¡†ï¼Œè¯´æ˜åŠŸèƒ½æ­£å¸¸ã€‚');
    } catch (e) {
        console.error('4. æ¨¡æ€æ¡†æ˜¾ç¤ºå¤±è´¥:', e);
        alert('é”™è¯¯ï¼šæ¨¡æ€æ¡†æ— æ³•æ˜¾ç¤º - ' + e.message);
    }
}

$(document).ready(function() {
    // è®¾ç½®å½“å‰æ—¥æœŸ
    $('#current-date').text(new Date().toLocaleDateString('zh-CN'));
    
    // è®¾ç½®æœ€åæ›´æ–°æ—¶é—´
    $('#last-update').text(new Date().toLocaleTimeString('zh-CN'));
    
    // ä¸å†éœ€è¦å¼‚æ­¥åŠ è½½ç”¨æˆ·æ˜µç§°ï¼Œç›´æ¥åœ¨æ¨¡æ¿ä¸­æ˜¾ç¤º
    
    // è°ƒè¯•å·¥å…·æç¤º
    console.log('==================== Dashboardé¡µé¢å·²åŠ è½½ ====================');
    console.log('ğŸ“‹ å¯ç”¨çš„è°ƒè¯•å‘½ä»¤:');
    console.log('  testAPI()      - æµ‹è¯•APIè¿æ¥å’Œæ•°æ®è·å–ï¼ˆæ¨èå…ˆè¿è¡Œï¼‰');
    console.log('  checkEvents()  - æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰èµ›äº‹æ•°æ®');
    console.log('  testModal()    - æµ‹è¯•æ¨¡æ€æ¡†æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤º');
    console.log('  viewEventDetail(ID) - æ‰‹åŠ¨æŸ¥çœ‹æŒ‡å®šèµ›äº‹è¯¦æƒ…');
    console.log('================================================================');
    
    // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
    loadDashboardData();
    
    // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®
    setInterval(function() {
        $('#last-update').text(new Date().toLocaleTimeString('zh-CN'));
    }, 30000);
});

// ä¸å†éœ€è¦å¼‚æ­¥åŠ è½½ç”¨æˆ·æ˜µç§°å‡½æ•°

function loadDashboardData() {
    loadStatistics();
    loadMySchedule();
}

function loadStatistics() {
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    $.ajax({
        url: '/api/dashboard/statistics',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#my-scores-count').text(response.statistics.my_scores || 0);
                $('#notifications-count').text(response.statistics.notifications || 0);
            } else {
                // æ˜¾ç¤ºé”™è¯¯æˆ–é»˜è®¤å€¼
                $('#my-scores-count').text('0');
                $('#notifications-count').text('0');
            }
        },
        error: function() {
            // æ˜¾ç¤ºé”™è¯¯æˆ–é»˜è®¤å€¼
            $('#my-scores-count').text('0');
            $('#notifications-count').text('0');
        }
    });
}

function loadMySchedule() {
    const container = $('#my-schedule');
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    container.html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½èµ›ç¨‹ä¿¡æ¯...</p>
        </div>
    `);
    
    // è°ƒç”¨çœŸå®APIè·å–èµ›ç¨‹æ•°æ®
    $.ajax({
        url: '/api/dashboard/my-schedule',
        method: 'GET',
        success: function(response) {
            container.empty();
            
            if (!response.success) {
                container.html(`
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                        <p class="text-muted mb-0">${response.message || 'åŠ è½½å¤±è´¥'}</p>
                    </div>
                `);
                return;
            }
            
            const schedules = response.schedules || [];
            
            if (schedules.length === 0) {
                container.html(`
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times text-muted fa-2x mb-2"></i>
                        <p class="text-muted mb-0">æš‚æ— å‚åŠ çš„èµ›äº‹</p>
                    </div>
                `);
                return;
            }
            
            schedules.forEach(function(schedule) {
                const statusConfig = getScheduleStatus(schedule.status);
                const countdown = getCountdown(schedule.event_time);
                const eventTime = formatDateTimeShort(schedule.event_time);
                
                const scheduleHtml = `
                    <div class="schedule-item border-start border-4 ps-3 mb-3" style="border-color: ${statusConfig.color} !important;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">${schedule.name}</h6>
                                <div class="schedule-info">
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-clock me-1 text-primary"></i>
                                        <strong>æ—¶é—´ï¼š</strong>${eventTime}
                                        ${countdown ? `<span class="badge bg-warning text-dark ms-2">${countdown}</span>` : ''}
                                    </p>
                                    <p class="text-muted small mb-1">
                                        <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                                        <strong>åœ°ç‚¹ï¼š</strong>${schedule.location}
                                    </p>
                                    <p class="text-muted small mb-0">
                                        <i class="fas fa-trophy me-1 text-success"></i>
                                        <strong>é¡¹ç›®ï¼š</strong>${schedule.project}
                                    </p>
                                </div>
                            </div>
                            ${schedule.status !== 'pending' ? `<span class="badge" style="background-color: ${statusConfig.color};">
                                ${statusConfig.text}
                            </span>` : ''}
                        </div>
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <button class="btn btn-lg btn-primary" onclick="viewEventDetail(${schedule.id})"><i class="fas fa-info-circle me-2"></i>æŸ¥çœ‹è¯¦æƒ…</button>
                        </div>
                    </div>
                `;
                container.append(scheduleHtml);
            });
        },
        error: function(xhr, status, error) {
            container.html(`
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-danger fa-2x mb-2"></i>
                    <p class="text-muted mb-0">åŠ è½½èµ›ç¨‹ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                </div>
            `);
            console.error('åŠ è½½èµ›ç¨‹å¤±è´¥:', error);
        }
    });
}

// è·å–èµ›ç¨‹çŠ¶æ€é…ç½®
function getScheduleStatus(status) {
    const statusMap = {
        'pending': { text: 'å¾…ç­¾åˆ°', color: '#3b82f6' },
        'ongoing': { text: 'è¿›è¡Œä¸­', color: '#f59e0b' },
        'completed': { text: 'å·²å®Œæˆ', color: '#10b981' }
    };
    return statusMap[status] || { text: 'æœªçŸ¥', color: '#6b7280' };
}

// è®¡ç®—å€’è®¡æ—¶
function getCountdown(eventTime) {
    const now = new Date();
    const event = new Date(eventTime);
    const diff = event - now;
    
    if (diff < 0) return null; // å·²è¿‡æœŸ
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    if (days > 0) return `${days}å¤©å`;
    if (hours > 0) return `${hours}å°æ—¶å`;
    if (minutes > 0) return `${minutes}åˆ†é’Ÿå`;
    return 'å³å°†å¼€å§‹';
}

// ç­¾åˆ°åŠŸèƒ½
function checkIn(eventId) {
    // TODO: è°ƒç”¨åç«¯ç­¾åˆ°æ¥å£
    showMessage('ç­¾åˆ°åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    console.log('ç­¾åˆ°èµ›äº‹ ID:', eventId);
}

// æŸ¥çœ‹èµ›äº‹è¯¦æƒ…
function viewEventDetail(eventId) {
    console.log('==================== å¼€å§‹æŸ¥çœ‹èµ›äº‹è¯¦æƒ… ====================');
    console.log('1. ä¼ å…¥çš„ eventId:', eventId);
    console.log('2. eventId ç±»å‹:', typeof eventId);
    console.log('3. eventId å€¼æ˜¯å¦æœ‰æ•ˆ:', eventId !== null && eventId !== undefined && eventId !== '');
    
    // éªŒè¯eventId
    if (!eventId || eventId === 'undefined' || eventId === 'null') {
        console.error('âŒ é”™è¯¯ï¼šèµ›äº‹IDæ— æ•ˆ!');
        alert('é”™è¯¯ï¼šèµ›äº‹IDæ— æ•ˆï¼Œæ— æ³•è·å–è¯¦æƒ…');
        return;
    }
    
    const apiUrl = `/api/events/${eventId}`;
    console.log('4. å®Œæ•´APIåœ°å€:', apiUrl);
    
    // è°ƒç”¨APIè·å–èµ›äº‹è¯¦æƒ…
    $.ajax({
        url: apiUrl,
        method: 'GET',
        beforeSend: function() {
            console.log('5. æ­£åœ¨å‘é€APIè¯·æ±‚...');
        },
        success: function(response) {
            console.log('6. âœ… APIè¯·æ±‚æˆåŠŸ!');
            console.log('7. å®Œæ•´å“åº”æ•°æ®:', response);
            
            if (response.success) {
                console.log('8. å“åº”æˆåŠŸï¼Œèµ›äº‹æ•°æ®:', response.event);
                showEventDetailModal(response.event);
            } else {
                console.error('9. âŒ å“åº”å¤±è´¥:', response.message);
                if (typeof showMessage === 'function') {
                    showMessage('è·å–èµ›äº‹è¯¦æƒ…å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                } else {
                    alert('è·å–èµ›äº‹è¯¦æƒ…å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('==================== APIè°ƒç”¨å¤±è´¥ ====================');
            console.error('çŠ¶æ€ç :', xhr.status);
            console.error('çŠ¶æ€æ–‡æœ¬:', xhr.statusText);
            console.error('é”™è¯¯ç±»å‹:', status);
            console.error('é”™è¯¯ä¿¡æ¯:', error);
            console.error('å®Œæ•´å“åº”:', xhr.responseText);
            
            let errorMsg = 'è·å–èµ›äº‹è¯¦æƒ…å¤±è´¥';
            
            if (xhr.status === 401) {
                errorMsg = 'æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
            } else if (xhr.status === 404) {
                errorMsg = 'èµ›äº‹ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
            } else if (xhr.status === 500) {
                errorMsg = 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            } else if (xhr.status === 0) {
                errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
            }
            
            console.error('æœ€ç»ˆé”™è¯¯æ¶ˆæ¯:', errorMsg);
            
            if (typeof showMessage === 'function') {
                showMessage(errorMsg, 'error');
            } else {
                alert(errorMsg);
            }
        }
    });
}

// æ˜¾ç¤ºèµ›äº‹è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆä½¿ç”¨èµ›äº‹å¤§å…¨çš„æ ·å¼ï¼‰
function showEventDetailModal(event) {
    console.log('æ˜¾ç¤ºèµ›äº‹è¯¦æƒ…æ¨¡æ€æ¡†, event:', event);
    
    if (!event) {
        console.error('eventå¯¹è±¡ä¸ºç©º');
        if (typeof showMessage === 'function') {
            showMessage('èµ›äº‹æ•°æ®ä¸ºç©º', 'error');
        } else {
            alert('èµ›äº‹æ•°æ®ä¸ºç©º');
        }
        return;
    }
    
    // ä»localStorageè·å–è´¹ç”¨æ•°æ®å¹¶å¢å¼ºeventå¯¹è±¡
    event = enhanceEventWithFees(event);
    
    // ç¡®ä¿æ¨¡æ€æ¡†å…ƒç´ å­˜åœ¨
    const modalElement = document.getElementById('eventDetailModal');
    if (!modalElement) {
        console.error('æ‰¾ä¸åˆ°æ¨¡æ€æ¡†å…ƒç´  #eventDetailModal');
        if (typeof showMessage === 'function') {
            showMessage('é¡µé¢åŠ è½½é”™è¯¯ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'error');
        } else {
            alert('é¡µé¢åŠ è½½é”™è¯¯ï¼Œè¯·åˆ·æ–°åé‡è¯•');
        }
        return;
    }
    
    console.log('è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜:', event.name);
    $('#eventDetailTitle').text(event.name);
    
    // ä½¿ç”¨èµ›äº‹å¤§å…¨ç›¸åŒçš„è¯¦æƒ…æ ·å¼
    const detailContent = `
        <div class="row">
            <div class="col-12">
                <h6>åŸºæœ¬ä¿¡æ¯</h6>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr><td width="40%">èµ›äº‹åç§°:</td><td>${event.name}</td></tr>
                            <tr><td>æ¯”èµ›åœ°ç‚¹:</td><td>${event.location || 'å¾…å®š'}</td></tr>
                            <tr><td>æ¯”èµ›å¼€å§‹æ—¶é—´:</td><td>${formatDateTime(event.start_date)}</td></tr>
                            <tr><td>æ¯”èµ›ç»“æŸæ—¶é—´:</td><td>${formatDateTime(event.end_date)}</td></tr>
                            <tr><td>æœ€å¤§äººæ•°:</td><td>${event.max_participants || 'ä¸é™'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr><td width="40%">æŠ¥åå¼€å§‹æ—¶é—´:</td><td>${formatDateTime(event.registration_start_time) || 'æœªè®¾ç½®'}</td></tr>
                            <tr><td>æŠ¥åæˆªæ­¢æ—¶é—´:</td><td>${formatDateTime(event.registration_deadline) || 'æœªè®¾ç½®'}</td></tr>
                            <tr><td>è”ç³»ç”µè¯:</td><td>${event.contact_phone || 'æœªè®¾ç½®'}</td></tr>
                            <tr><td>ä¸»åŠå•ä½:</td><td>${event.organizer || 'æœªè®¾ç½®'}</td></tr>
                            <tr><td>æ‰¿åŠå•ä½:</td><td>${event.co_organizer || 'æœªè®¾ç½®'}</td></tr>
                        </table>
                    </div>
                </div>
                ${(event.individual_fee > 0 || event.pair_practice_fee > 0 || event.team_competition_fee > 0) ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>æŠ¥åè´¹ç”¨</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">ä¸ªäººèµ›æŠ¥åè´¹ç”¨</small>
                                    <strong class="text-success">Â¥${(event.individual_fee || 0).toFixed(2)}</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">å¯¹ç»ƒæŠ¥åè´¹ç”¨</small>
                                    <strong class="text-success">Â¥${(event.pair_practice_fee || 0).toFixed(2)}</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">å›¢ä½“èµ›æŠ¥åè´¹ç”¨</small>
                                    <strong class="text-success">Â¥${(event.team_competition_fee || 0).toFixed(2)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>æŠ¥åçŠ¶æ€:</strong> <span class="badge ${getRegistrationStatus(event).color}">${getRegistrationStatus(event).text}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>æ¯”èµ›çŠ¶æ€:</strong> <span class="badge ${getEventStatus(event).color}">${getEventStatus(event).text}</span>
                    </div>
                </div>
            </div>
        </div>
        ${event.description ? `
            <div class="mt-3">
                <h6>èµ›äº‹æè¿°</h6>
                <p class="text-muted">${event.description}</p>
            </div>
        ` : ''}
    `;
    
    $('#eventDetailContent').html(detailContent);
    
    // æ¸…ç©ºæ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆä¸æ˜¾ç¤ºæŠ¥åæŒ‰é’®ï¼‰
    $('#eventDetailActions').html('');
    
    console.log('å‡†å¤‡æ˜¾ç¤ºæ¨¡æ€æ¡†ï¼ˆæ— èƒŒæ™¯é®ç½©ï¼‰...');
    
    // ç¡®ä¿å…ˆéšè—å…¶ä»–å¯èƒ½å­˜åœ¨çš„æ¨¡æ€æ¡†
    $('.modal').removeClass('show').hide();
    $('.modal-backdrop').remove();
    
    const modalEl = document.getElementById('eventDetailModal');
    
    // ç§»é™¤fadeç±»é¿å…åŠ¨ç”»
    modalEl.classList.remove('fade');
    
    // è®¾ç½®æ¨¡æ€æ¡†ä¸ºæ˜¾ç¤ºçŠ¶æ€
    modalEl.classList.add('show');
    modalEl.style.display = 'block';
    modalEl.setAttribute('aria-modal', 'true');
    modalEl.removeAttribute('aria-hidden');
    
    console.log('âœ… æ¨¡æ€æ¡†å·²æ˜¾ç¤ºï¼ˆæ— èƒŒæ™¯é®ç½©ï¼‰');
}

// è®¡ç®—æŠ¥åçŠ¶æ€ï¼ˆä¸èµ›äº‹å¤§å…¨ä¿æŒä¸€è‡´ï¼‰
function getRegistrationStatus(event) {
    const now = new Date();
    const regStart = event.registration_start_time ? new Date(event.registration_start_time) : null;
    const regEnd = event.registration_deadline ? new Date(event.registration_deadline) : null;
    
    if (!regStart || !regEnd) {
        return { text: 'æŠ¥åæœªè®¾ç½®', color: 'bg-light text-dark' };
    }
    
    if (now < regStart) {
        return { text: 'æŠ¥åæœªå¼€å§‹', color: 'bg-secondary' };
    } else if (now >= regStart && now <= regEnd) {
        return { text: 'æŠ¥åè¿›è¡Œä¸­', color: 'bg-success' };
    } else {
        return { text: 'æŠ¥åå·²æˆªæ­¢', color: 'bg-danger' };
    }
}

// è®¡ç®—æ¯”èµ›çŠ¶æ€ï¼ˆä¸èµ›äº‹å¤§å…¨ä¿æŒä¸€è‡´ï¼‰
function getEventStatus(event) {
    const now = new Date();
    const eventStart = event.start_date ? new Date(event.start_date) : null;
    const eventEnd = event.end_date ? new Date(event.end_date) : null;
    
    if (!eventStart || !eventEnd) {
        return { text: 'æ—¶é—´æœªè®¾ç½®', color: 'bg-light text-dark' };
    }
    
    if (now < eventStart) {
        return { text: 'æœªå¼€å§‹', color: 'bg-info' };
    } else if (now >= eventStart && now <= eventEnd) {
        return { text: 'è¿›è¡Œä¸­', color: 'bg-warning' };
    } else {
        return { text: 'å·²ç»“æŸ', color: 'bg-secondary' };
    }
}

// è·å–æŠ¥åæŒ‰é’®çŠ¶æ€
function getRegistrationStatusForButton(event) {
    const now = new Date();
    const regStart = event.registration_start_time ? new Date(event.registration_start_time) : null;
    const regEnd = event.registration_deadline ? new Date(event.registration_deadline) : null;
    
    // å¦‚æœæ²¡æœ‰è®¾ç½®æŠ¥åæ—¶é—´ï¼Œé»˜è®¤å¯ä»¥æŠ¥å
    if (!regStart || !regEnd) {
        return { 
            canRegister: true, 
            reason: 'å¯ä»¥æŠ¥å' 
        };
    }
    
    if (now < regStart) {
        return { 
            canRegister: false, 
            reason: 'æŠ¥åæœªå¼€å§‹' 
        };
    } else if (now > regEnd) {
        return { 
            canRegister: false, 
            reason: 'æŠ¥åå·²æˆªæ­¢' 
        };
    } else {
        return { 
            canRegister: true, 
            reason: 'æŠ¥åè¿›è¡Œä¸­' 
        };
    }
}

// å…³é—­èµ›äº‹è¯¦æƒ…æ¨¡æ€æ¡†
function closeEventModal() {
    console.log('å…³é—­æ¨¡æ€æ¡†');
    const modalEl = document.getElementById('eventDetailModal');
    modalEl.classList.remove('show');
    modalEl.style.display = 'none';
    
    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„èƒŒæ™¯é®ç½©
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
}

// æŠ¥åå‚èµ›
function registerForEvent(eventId) {
    // è·³è½¬åˆ°æŠ¥åé¡µé¢ï¼Œé€‰æ‹©è¯¥èµ›äº‹
    window.location.href = `/event_selection?event_id=${eventId}`;
}

function refreshDashboard() {
    showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
    loadDashboardData();
    setTimeout(function() {
        showMessage('æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
    }, 1000);
}

function showQuickCreateEventModal() {
    // ä½¿ç”¨å…±ç”¨çš„åˆ›å»ºæ¨¡æ€æ¡†å‡½æ•°
    showCreateEventModal();
}

// submitQuickCreateEvent ç°åœ¨ç”±å…±ç”¨çš„ submitEventForm æ›¿ä»£
function submitQuickCreateEvent() {
    submitEventForm();
}

function manageParticipants() {
    window.location.href = '/participants';
}

function registerForEvent() {
    window.location.href = '/events';
}

function startScoring() {
    // showMessage('è¯„åˆ†ç³»ç»Ÿå¼€å‘ä¸­...', 'info');
    window.location.href = '/events';
}

function viewResults() {
    window.location.href = '/results';
}

// æŸ¥çœ‹é€šçŸ¥
function viewNotifications() {
    // æ£€æŸ¥ç”¨æˆ·è§’è‰²
    const userRole = '{{ user_role }}';
    if (userRole === 'super_admin') {
        // è¶…çº§ç®¡ç†å‘˜è·³è½¬åˆ°å‘é€é€šçŸ¥é¡µé¢
        window.location.href = '/send_notification';
    } else {
        // å…¶ä»–ç”¨æˆ·è·³è½¬åˆ°æŸ¥çœ‹é€šçŸ¥é¡µé¢
        window.location.href = '/notifications';
    }
}

function getStatusColor(status) {
    const colors = {
        'draft': 'secondary',
        'published': 'primary',
        'ongoing': 'warning',
        'completed': 'success',
        'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
}

// æ ¹æ®æ—¶é—´è‡ªåŠ¨è®¡ç®—èµ›äº‹çŠ¶æ€
function getAutoStatus(event) {
    const now = new Date();
    const startDate = new Date(event.start_date);
    const endDate = new Date(event.end_date);
    
    // å¦‚æœæœ‰æŠ¥åæ—¶é—´ï¼Œä¹Ÿè€ƒè™‘æŠ¥åçŠ¶æ€
    if (event.registration_deadline) {
        const regDeadline = new Date(event.registration_deadline);
        const regStart = event.registration_start_time ? new Date(event.registration_start_time) : null;
        
        // å¦‚æœè¿˜åœ¨æŠ¥åæœŸé—´
        if (regStart && now >= regStart && now <= regDeadline && now < startDate) {
            return 'registration'; // æŠ¥åä¸­
        }
        
        // å¦‚æœæŠ¥åå·²æˆªæ­¢ä½†èµ›äº‹æœªå¼€å§‹
        if (now > regDeadline && now < startDate) {
            return 'registration_closed'; // æŠ¥åå·²æˆªæ­¢
        }
    }
    
    if (now < startDate) {
        // å¦‚æœæ˜¯ä»Šå¤©çš„èµ›äº‹ï¼Œæ˜¾ç¤ºä¸º"å³å°†å¼€å§‹"è€Œä¸æ˜¯"è‰ç¨¿"
        const today = new Date();
        const eventDate = new Date(startDate);
        const isToday = today.toDateString() === eventDate.toDateString();
        
        if (isToday && event.status === 'draft') {
            return 'upcoming'; // å³å°†å¼€å§‹
        }
        return event.status === 'draft' ? 'draft' : 'published'; // æœªå¼€å§‹
    } else if (now >= startDate && now <= endDate) {
        return 'ongoing'; // è¿›è¡Œä¸­
    } else {
        return event.status === 'cancelled' ? 'cancelled' : 'completed'; // å·²ç»“æŸæˆ–å·²å–æ¶ˆ
    }
}

// è·å–æ˜¾ç¤ºç”¨çš„çŠ¶æ€æ–‡æœ¬ï¼ˆåŸºäºæ—¶é—´è‡ªåŠ¨åˆ¤æ–­ï¼‰
function getDisplayStatus(event) {
    const autoStatus = getAutoStatus(event);
    const statusTexts = {
        'draft': 'æŠ¥åæœªå¼€å§‹',
        'published': 'æœªå¼€å§‹',
        'upcoming': 'å³å°†å¼€å§‹',
        'registration': 'æŠ¥åä¸­',
        'registration_closed': 'æŠ¥åæˆªæ­¢',
        'ongoing': 'è¿›è¡Œä¸­',
        'completed': 'å·²ç»“æŸ',
        'cancelled': 'å·²å–æ¶ˆ'
    };
    return statusTexts[autoStatus] || 'æœªçŸ¥';
}

// è·å–æ˜¾ç¤ºç”¨çš„çŠ¶æ€é¢œè‰²ï¼ˆåŸºäºæ—¶é—´è‡ªåŠ¨åˆ¤æ–­ï¼‰
function getDisplayStatusColor(event) {
    const autoStatus = getAutoStatus(event);
    const statusColors = {
        'draft': 'secondary',
        'published': 'info',
        'upcoming': 'warning',
        'registration': 'success',
        'registration_closed': 'warning',
        'ongoing': 'primary',
        'completed': 'dark',
        'cancelled': 'danger'
    };
    return statusColors[autoStatus] || 'secondary';
}

// ==================== é€šç”¨ç¡®è®¤å¯¹è¯æ¡† ====================

// æ˜¾ç¤ºç»Ÿä¸€çš„ç¡®è®¤å¯¹è¯æ¡†
function showConfirmDialog(title, message, confirmCallback, options = {}) {
    const {
        confirmText = 'ç¡®è®¤',
        cancelText = 'å–æ¶ˆ',
        confirmClass = 'btn-primary',
        icon = 'fas fa-question-circle',
        danger = false
    } = options;
    
    const modalClass = danger ? 'border-danger' : '';
    const headerClass = danger ? 'bg-danger text-white' : 'bg-primary text-white';
    const btnClass = danger ? 'btn-danger' : confirmClass;
    
    const modalHtml = `
        <div class="modal fade" id="confirmDialog" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered ${modalClass}">
                <div class="modal-content">
                    <div class="modal-header ${headerClass}">
                        <h5 class="modal-title">
                            <i class="${icon} me-2"></i>${title}
                        </h5>
                        <button type="button" class="btn-close ${danger ? 'btn-close-white' : ''}" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${message.split('\n').map(line => `<p class="mb-2">${line}</p>`).join('')}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            ${cancelText}
                        </button>
                        <button type="button" class="btn ${btnClass}" id="confirmBtn">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤æ—§å¯¹è¯æ¡†
    const oldModal = document.getElementById('confirmDialog');
    if (oldModal) oldModal.remove();
    
    // æ·»åŠ æ–°å¯¹è¯æ¡†
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('confirmDialog'));
    
    // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶
    document.getElementById('confirmBtn').onclick = function() {
        modal.hide();
        setTimeout(() => {
            if (confirmCallback) confirmCallback();
        }, 150);
    };
    
    modal.show();
}

// ==================== ç³»ç»Ÿç»´æŠ¤åŠŸèƒ½ ====================

// å¤‡ä»½æ•°æ®åº“
function maintenanceBackup() {
    showConfirmDialog(
        'ç¡®è®¤å¤‡ä»½æ•°æ®åº“',
        'æ­¤æ“ä½œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚\nç¡®è®¤è¦å¤‡ä»½æ•°æ®åº“å—ï¼Ÿ',
        function() {
            showCenterMessage('æ­£åœ¨å¤‡ä»½æ•°æ®åº“ï¼Œè¯·ç¨å€™...', 'info');
            
            fetch('/api/admin/maintenance/backup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCenterMessage('âœ… ' + data.message, 'success');
                    updateLastMaintTime();
                } else {
                    showCenterMessage('âŒ ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('å¤‡ä»½å¤±è´¥:', error);
                showCenterMessage('âŒ å¤‡ä»½å¤±è´¥: ' + error, 'error');
            });
        },
        { icon: 'fas fa-save', confirmClass: 'btn-primary' }
    );
}

// ä¼˜åŒ–æ•°æ®åº“
function maintenanceOptimize() {
    showConfirmDialog(
        'ç¡®è®¤ä¼˜åŒ–æ•°æ®åº“',
        'æ­¤æ“ä½œä¼šæš‚æ—¶é”å®šè¡¨ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚\nç¡®è®¤è¦ä¼˜åŒ–æ•°æ®åº“å—ï¼Ÿ',
        function() {
            showCenterMessage('æ­£åœ¨ä¼˜åŒ–æ•°æ®åº“ï¼Œè¯·ç¨å€™...', 'info');
            
            fetch('/api/admin/maintenance/optimize', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCenterMessage('âœ… ' + data.message, 'success');
                    updateLastMaintTime();
                } else {
                    showCenterMessage('âŒ ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('ä¼˜åŒ–å¤±è´¥:', error);
                showCenterMessage('âŒ ä¼˜åŒ–å¤±è´¥: ' + error, 'error');
            });
        },
        { icon: 'fas fa-cog', confirmClass: 'btn-success' }
    );
}

// æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
function maintenanceStats() {
    showCenterMessage('æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...', 'info');
    
    fetch('/api/admin/maintenance/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatsModal(data.stats);
        } else {
            showCenterMessage('âŒ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
        showCenterMessage('âŒ è·å–ç»Ÿè®¡å¤±è´¥', 'error');
    });
}

// æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯æ¨¡æ€æ¡†
function showStatsModal(stats) {
    let userHtml = '';
    if (stats.users && stats.users.length > 0) {
        const roleNames = {
            'super_admin': 'è¶…çº§ç®¡ç†å‘˜',
            'admin': 'ç®¡ç†å‘˜',
            'judge': 'è£åˆ¤',
            'user': 'æ™®é€šç”¨æˆ·'
        };
        stats.users.forEach(u => {
            userHtml += `<li><i class="fas fa-user-circle me-2"></i>${roleNames[u.role] || u.role}: <strong>${u.count}</strong> äºº</li>`;
        });
    }
    
    let eventHtml = '';
    if (stats.events && stats.events.length > 0) {
        const statusNames = {
            'draft': 'è‰ç¨¿',
            'published': 'å·²å‘å¸ƒ',
            'ongoing': 'è¿›è¡Œä¸­',
            'completed': 'å·²å®Œæˆ',
            'cancelled': 'å·²å–æ¶ˆ'
        };
        stats.events.forEach(e => {
            eventHtml += `<li><i class="fas fa-trophy me-2"></i>${statusNames[e.status] || e.status}: <strong>${e.count}</strong> ä¸ª</li>`;
        });
    }
    
    const modalHtml = `
        <div class="modal fade maintenance-modal" id="statsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header stats-header">
                        <h5 class="modal-title"><i class="fas fa-chart-line"></i>ç³»ç»Ÿæ•°æ®ç»Ÿè®¡</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <div class="stats-card db-size">
                                    <div class="card-body">
                                        <i class="fas fa-database" style="font-size: 2.5rem; opacity: 0.9; margin-bottom: 1rem;"></i>
                                        <h2>${stats.db_size || 0}</h2>
                                        <p>æ•°æ®åº“å¤§å° (MB)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="stats-card participants">
                                    <div class="card-body">
                                        <i class="fas fa-users" style="font-size: 2.5rem; opacity: 0.9; margin-bottom: 1rem;"></i>
                                        <h2>${stats.participants || 0}</h2>
                                        <p>å‚èµ›äººæ•°æ€»è®¡</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="stats-list">
                            <h6><i class="fas fa-user-friends me-2" style="color: #5DADE2;"></i>ç”¨æˆ·ç»Ÿè®¡</h6>
                            <ul>${userHtml || '<li>æš‚æ— æ•°æ®</li>'}</ul>
                        </div>
                        <div class="stats-list">
                            <h6><i class="fas fa-calendar-alt me-2" style="color: #5DADE2;"></i>èµ›äº‹ç»Ÿè®¡</h6>
                            <ul>${eventHtml || '<li>æš‚æ— æ•°æ®</li>'}</ul>
                        </div>
                        <div class="info-alert">
                            <i class="fas fa-clock me-2"></i>
                            <strong>æœ€åå¤‡ä»½æ—¶é—´:</strong> ${stats.last_backup || 'ä»æœªå¤‡ä»½'}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>å…³é—­
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('statsModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('statsModal'));
    modal.show();
}

// æŸ¥çœ‹æ“ä½œæ—¥å¿—
function maintenanceLogs() {
    showCenterMessage('æ­£åœ¨åŠ è½½æ—¥å¿—...', 'info');
    
    fetch('/api/admin/maintenance/logs')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showLogsModal(data.logs);
        } else {
            showCenterMessage('âŒ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
        showCenterMessage('âŒ è·å–æ—¥å¿—å¤±è´¥', 'error');
    });
}

// æ˜¾ç¤ºæ—¥å¿—æ¨¡æ€æ¡†
function showLogsModal(logs) {
    const opNames = {
        'database_backup': 'æ•°æ®åº“å¤‡ä»½',
        'database_optimize': 'æ•°æ®åº“ä¼˜åŒ–',
        'database_restore': 'æ•°æ®åº“æ¢å¤',
        'backup_delete': 'åˆ é™¤å¤‡ä»½',
        'backup_download': 'ä¸‹è½½å¤‡ä»½',
        'file_cleanup': 'æ–‡ä»¶æ¸…ç†'
    };
    
    const logsHtml = logs.map(log => {
        const statusBadge = log.status === 'success' 
            ? '<span class="badge bg-success">æˆåŠŸ</span>' 
            : '<span class="badge bg-danger">å¤±è´¥</span>';
        
        const duration = log.duration ? `${log.duration}ç§’` : '-';
        const fileSize = log.file_size ? `${log.file_size}MB` : '-';
        
        return `
        <tr class="${log.status === 'failed' ? 'table-danger' : ''}">
            <td>${log.created_at}</td>
            <td>${opNames[log.operation] || log.operation}</td>
            <td>${log.real_name || log.username}</td>
            <td>${statusBadge}</td>
            <td>${duration}</td>
            <td>${fileSize}</td>
            <td>
                ${log.details}
                ${log.error_message ? `<br><small class="text-danger">é”™è¯¯: ${log.error_message}</small>` : ''}
            </td>
        </tr>
        `;
    }).join('');
    
    const modalHtml = `
        <div class="modal fade maintenance-modal" id="logsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header logs-header">
                        <h5 class="modal-title"><i class="fas fa-history"></i>ç³»ç»Ÿç»´æŠ¤æ—¥å¿—</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table logs-table">
                                <thead class="sticky-top">
                                    <tr>
                                        <th width="140"><i class="fas fa-clock me-1"></i>æ—¶é—´</th>
                                        <th width="100"><i class="fas fa-tasks me-1"></i>æ“ä½œ</th>
                                        <th width="80"><i class="fas fa-user me-1"></i>æ“ä½œäºº</th>
                                        <th width="60"><i class="fas fa-check-circle me-1"></i>çŠ¶æ€</th>
                                        <th width="70"><i class="fas fa-stopwatch me-1"></i>è€—æ—¶</th>
                                        <th width="80"><i class="fas fa-file-archive me-1"></i>æ–‡ä»¶å¤§å°</th>
                                        <th><i class="fas fa-info-circle me-1"></i>è¯¦æƒ…</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${logsHtml || '<tr><td colspan="7" class="text-center py-4"><i class="fas fa-inbox text-muted" style="font-size: 2rem;"></i><p class="mt-2 text-muted">æš‚æ— æ—¥å¿—è®°å½•</p></td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>å…³é—­
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('logsModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('logsModal'));
    modal.show();
}

// æ¸…ç†æ–‡ä»¶
function maintenanceClean() {
    showConfirmDialog(
        'ç¡®è®¤æ¸…ç†ç³»ç»Ÿæ–‡ä»¶',
        'å°†åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œæ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰ã€‚\nç¡®è®¤è¦æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶å—ï¼Ÿ',
        function() {
            showCenterMessage('æ­£åœ¨æ¸…ç†æ–‡ä»¶...', 'info');
            
            fetch('/api/admin/maintenance/cleanup', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCenterMessage(`âœ… ${data.message}\næ¸…ç†: ${data.cleaned_files}ä¸ªæ–‡ä»¶\né‡Šæ”¾: ${data.freed_space}`, 'success');
                    updateLastMaintTime();
                } else {
                    showCenterMessage('âŒ ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('æ¸…ç†å¤±è´¥:', error);
                showCenterMessage('âŒ æ¸…ç†å¤±è´¥: ' + error, 'error');
            });
        },
        { icon: 'fas fa-broom', confirmClass: 'btn-warning' }
    );
}

// æ›´æ–°æœ€åç»´æŠ¤æ—¶é—´
function updateLastMaintTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('zh-CN');
    document.getElementById('lastMaintTime').textContent = timeStr;
}

// ç³»ç»Ÿå¥åº·æ£€æŸ¥
function maintenanceHealth() {
    showCenterMessage('æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€...', 'info');
    
    fetch('/api/admin/maintenance/health')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showHealthModal(data);
        } else {
            showCenterMessage('âŒ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
        showCenterMessage('âŒ å¥åº·æ£€æŸ¥å¤±è´¥', 'error');
    });
}

// æ˜¾ç¤ºå¥åº·æ£€æŸ¥æ¨¡æ€æ¡†
function showHealthModal(data) {
    const statusIcons = {
        'healthy': '<i class="fas fa-check-circle text-success"></i>',
        'warning': '<i class="fas fa-exclamation-triangle text-warning"></i>',
        'error': '<i class="fas fa-times-circle text-danger"></i>',
        'critical': '<i class="fas fa-skull-crossbones text-danger"></i>',
        'info': '<i class="fas fa-info-circle text-info"></i>',
        'unknown': '<i class="fas fa-question-circle text-secondary"></i>'
    };
    
    const statusColors = {
        'healthy': 'success',
        'warning': 'warning',
        'error': 'danger',
        'critical': 'danger',
        'info': 'info',
        'unknown': 'secondary'
    };
    
    const overallColor = statusColors[data.overall_status] || 'secondary';
    const overallIcon = statusIcons[data.overall_status] || statusIcons['unknown'];
    
    const healthHtml = Object.entries(data.health).map(([key, item]) => {
        const icon = statusIcons[item.status] || statusIcons['unknown'];
        const color = statusColors[item.status] || 'secondary';
        
        const titles = {
            'database': 'æ•°æ®åº“è¿æ¥',
            'disk': 'ç£ç›˜ç©ºé—´',
            'backup': 'å¤‡ä»½çŠ¶æ€',
            'tables': 'æ•°æ®è¡¨'
        };
        
        const itemIcons = {
            'database': 'fas fa-database',
            'disk': 'fas fa-hdd',
            'backup': 'fas fa-save',
            'tables': 'fas fa-table'
        };
        
        return `
            <div class="health-check-card ${item.status}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6>
                            <i class="${itemIcons[key] || 'fas fa-info-circle'}"></i>
                            ${titles[key] || key}
                        </h6>
                        <p class="mb-2" style="color: #4a5568;">${item.message}</p>
                        ${item.free_space ? `<div class="small text-muted"><i class="fas fa-chart-pie me-1"></i>å¯ç”¨ç©ºé—´: ${item.free_space} (å·²ä½¿ç”¨: ${item.used_percent})</div>` : ''}
                        ${item.last_backup ? `<div class="small text-muted"><i class="fas fa-clock me-1"></i>æœ€åå¤‡ä»½: ${item.last_backup}</div>` : ''}
                        ${item.backup_count !== undefined ? `<div class="small text-muted"><i class="fas fa-file-archive me-1"></i>å¤‡ä»½æ–‡ä»¶æ•°: ${item.backup_count}</div>` : ''}
                        ${item.table_count !== undefined ? `<div class="small text-muted"><i class="fas fa-list me-1"></i>æ•°æ®è¡¨æ•°é‡: ${item.table_count}</div>` : ''}
                    </div>
                    <span class="health-status-badge bg-${color}">${icon}</span>
                </div>
            </div>
        `;
    }).join('');
    
    const overallStatusText = {
        'healthy': 'å¥åº·',
        'warning': 'è­¦å‘Š',
        'error': 'é”™è¯¯',
        'critical': 'ä¸¥é‡',
        'info': 'ä¿¡æ¯',
        'unknown': 'æœªçŸ¥'
    };
    
    const modalHtml = `
        <div class="modal fade maintenance-modal" id="healthModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header health-header">
                        <h5 class="modal-title"><i class="fas fa-heartbeat"></i>ç³»ç»Ÿå¥åº·æ£€æŸ¥</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div style="background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%); color: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h4 class="mb-1">${overallIcon} ${overallStatusText[data.overall_status] || data.overall_status}</h4>
                                    <p class="mb-0 opacity-90"><i class="fas fa-clock me-2"></i>æ£€æŸ¥æ—¶é—´: ${data.check_time}</p>
                                </div>
                                <div style="font-size: 3rem; opacity: 0.8;">
                                    ${data.overall_status === 'healthy' ? 'âœ…' : data.overall_status === 'warning' ? 'âš ï¸' : 'âŒ'}
                                </div>
                            </div>
                        </div>
                        ${healthHtml}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>å…³é—­
                        </button>
                        <button type="button" class="btn btn-primary" onclick="maintenanceHealth()">
                            <i class="fas fa-sync-alt me-1"></i>é‡æ–°æ£€æŸ¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('healthModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('healthModal'));
    modal.show();
}

// æŸ¥çœ‹å¤‡ä»½ç®¡ç†
function maintenanceViewBackups() {
    showCenterMessage('æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...', 'info');
    
    fetch('/api/admin/maintenance/backups')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showBackupsModal(data.backups, data.total);
        } else {
            showCenterMessage('âŒ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥:', error);
        showCenterMessage('âŒ è·å–å¤‡ä»½åˆ—è¡¨å¤±è´¥', 'error');
    });
}

// æ˜¾ç¤ºå¤‡ä»½ç®¡ç†æ¨¡æ€æ¡†
function showBackupsModal(backups, total) {
    const userRole = '{{ user_role }}';
    const backupsHtml = backups.map((b, index) => `
        <tr class="backup-row" data-filename="${b.filename.toLowerCase()}">
            <td>${index + 1}</td>
            <td><code>${b.filename}</code></td>
            <td>${b.size}</td>
            <td>${b.created_at}</td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="downloadBackup('${b.filename}')" title="ä¸‹è½½å¤‡ä»½">
                    <i class="fas fa-download"></i>
                </button>
                ${userRole === 'super_admin' ? `
                    <button class="btn btn-sm btn-success me-1" onclick="restoreBackup('${b.filename}')" title="æ¢å¤æ•°æ®åº“">
                        <i class="fas fa-undo"></i>
                    </button>
                ` : ''}
                <button class="btn btn-sm btn-danger" onclick="deleteBackup('${b.filename}')" title="åˆ é™¤å¤‡ä»½">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    const modalHtml = `
        <div class="modal fade maintenance-modal" id="backupsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header backup-header">
                        <h5 class="modal-title">
                            <i class="fas fa-server"></i>å¤‡ä»½æ–‡ä»¶ç®¡ç†
                            <span class="badge bg-white text-primary ms-2" style="font-weight: 700;">${total} ä¸ªæ–‡ä»¶</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${backups.length > 0 ? `
                            <div class="row mb-4">
                                <div class="col-md-6 mb-3">
                                    <div class="info-alert">
                                        <i class="fas fa-shield-alt me-2"></i>
                                        <strong>ä¿æŠ¤ç­–ç•¥:</strong> ç³»ç»Ÿè‡ªåŠ¨ä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½æ–‡ä»¶
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text" style="background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%); color: white; border: none;">
                                            <i class="fas fa-search"></i>
                                        </span>
                                        <input type="text" class="form-control backup-search" id="backupSearchInput" 
                                               placeholder="ğŸ” æœç´¢å¤‡ä»½æ–‡ä»¶..." 
                                               onkeyup="filterBackups()" style="border-left: none;">
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table backup-table">
                                    <thead class="sticky-top">
                                        <tr>
                                            <th width="60"><i class="fas fa-hashtag me-1"></i>#</th>
                                            <th><i class="fas fa-file-code me-1"></i>æ–‡ä»¶å</th>
                                            <th width="120"><i class="fas fa-weight me-1"></i>å¤§å°</th>
                                            <th width="180"><i class="fas fa-calendar me-1"></i>åˆ›å»ºæ—¶é—´</th>
                                            <th width="200"><i class="fas fa-cogs me-1"></i>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${backupsHtml}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="text-center py-5">
                                <i class="fas fa-folder-open" style="font-size: 4rem; color: #cbd5e0; margin-bottom: 1rem;"></i>
                                <h5 style="color: #718096;">æš‚æ— å¤‡ä»½æ–‡ä»¶</h5>
                                <p class="text-muted">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå¤‡ä»½</p>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>å…³é—­
                        </button>
                        <button type="button" class="btn btn-primary" onclick="maintenanceBackup(); bootstrap.Modal.getInstance(document.getElementById('backupsModal')).hide();">
                            <i class="fas fa-plus-circle me-1"></i>æ–°å»ºå¤‡ä»½
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('backupsModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('backupsModal'));
    modal.show();
}

// ä¸‹è½½å¤‡ä»½æ–‡ä»¶
function downloadBackup(filename) {
    showCenterMessage('æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 'info');
    
    // ç›´æ¥é€šè¿‡é“¾æ¥ä¸‹è½½
    window.location.href = `/api/admin/maintenance/backups/${filename}/download`;
    
    setTimeout(() => {
        showCenterMessage('âœ… ä¸‹è½½å·²å¼€å§‹', 'success');
    }, 500);
}

// æœç´¢è¿‡æ»¤å¤‡ä»½æ–‡ä»¶
function filterBackups() {
    const searchInput = document.getElementById('backupSearchInput');
    const filter = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('.backup-row');
    
    let visibleCount = 0;
    rows.forEach(row => {
        const filename = row.getAttribute('data-filename');
        if (filename.includes(filter)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // å¦‚æœæ²¡æœ‰åŒ¹é…ç»“æœï¼Œæ˜¾ç¤ºæç¤º
    if (visibleCount === 0 && filter) {
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ "æ— æœç´¢ç»“æœ"çš„æç¤º
    }
}

// åˆ é™¤å¤‡ä»½æ–‡ä»¶
function deleteBackup(filename) {
    showConfirmDialog(
        'ç¡®è®¤åˆ é™¤å¤‡ä»½æ–‡ä»¶',
        `æ–‡ä»¶å: ${filename}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼\nç¡®è®¤è¦åˆ é™¤æ­¤å¤‡ä»½æ–‡ä»¶å—ï¼Ÿ`,
        function() {
            showCenterMessage('æ­£åœ¨åˆ é™¤...', 'info');
            
            fetch(`/api/admin/maintenance/backups/${filename}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCenterMessage('âœ… ' + data.message, 'success');
                    // åˆ·æ–°å¤‡ä»½åˆ—è¡¨
                    setTimeout(() => maintenanceViewBackups(), 1000);
                } else {
                    showCenterMessage('âŒ ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showCenterMessage('âŒ åˆ é™¤å¤±è´¥: ' + error, 'error');
            });
        },
        { icon: 'fas fa-trash', danger: true, confirmText: 'ç¡®è®¤åˆ é™¤' }
    );
}

// æ¢å¤æ•°æ®åº“å¤‡ä»½
function restoreBackup(filename) {
    // ç¬¬ä¸€æ¬¡ç¡®è®¤
    showConfirmDialog(
        'âš ï¸ å±é™©æ“ä½œè­¦å‘Š',
        `ç¡®è®¤è¦æ¢å¤æ•°æ®åº“å—ï¼Ÿ\nå¤‡ä»½æ–‡ä»¶: ${filename}\n\næ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼\nå»ºè®®å…ˆå¤‡ä»½å½“å‰æ•°æ®åº“å†æ‰§è¡Œæ¢å¤æ“ä½œã€‚`,
        function() {
            // æ˜¾ç¤ºç¡®è®¤ç è¾“å…¥æ¡†
            showRestoreConfirmModal(filename);
        },
        { icon: 'fas fa-exclamation-triangle', danger: true, confirmText: 'ç»§ç»­æ“ä½œ' }
    );
}

// æ˜¾ç¤ºæ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
function showRestoreConfirmModal(filename) {
    const modalHtml = `
        <div class="modal fade maintenance-modal" id="restoreConfirmModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content" style="border: 3px solid #f56565;">
                    <div class="modal-header danger-header">
                        <h5 class="modal-title">
                            <i class="fas fa-radiation-alt"></i>âš ï¸ ç¡®è®¤æ¢å¤æ•°æ®åº“
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="restore-warning">
                            <h6><i class="fas fa-skull-crossbones"></i>ä¸¥é‡è­¦å‘Š - å±é™©æ“ä½œ</h6>
                            <ul>
                                <li>â›” æ­¤æ“ä½œå°†<strong style="color: #c53030; font-size: 1.1em;">å®Œå…¨è¦†ç›–</strong>å½“å‰æ•°æ®åº“</li>
                                <li>ğŸ’€ æ‰€æœ‰æœªå¤‡ä»½çš„æ•°æ®å°†<strong style="color: #c53030; font-size: 1.1em;">æ°¸ä¹…ä¸¢å¤±</strong></li>
                                <li>ğŸš« æ‰€æœ‰ç”¨æˆ·å°†è¢«<strong style="color: #c53030; font-size: 1.1em;">å¼ºåˆ¶ä¸‹çº¿</strong></li>
                                <li>âš ï¸ æ­¤æ“ä½œ<strong style="color: #c53030; font-size: 1.1em;">ä¸å¯æ’¤é”€</strong></li>
                            </ul>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label" style="font-size: 1.1rem; color: #2d3748; font-weight: 600;">
                                <i class="fas fa-file-archive me-2" style="color: #5DADE2;"></i>å¤‡ä»½æ–‡ä»¶:
                            </label>
                            <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: 2px solid #0097a7; border-radius: 12px; padding: 1rem;">
                                <code style="font-size: 1.1rem; color: #00838f; font-weight: 600;">${filename}</code>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="restoreConfirmInput" class="form-label" style="font-size: 1.1rem; font-weight: 600; color: #2d3748;">
                                <i class="fas fa-keyboard me-2" style="color: #e53e3e;"></i>
                                è¯·è¾“å…¥ <span style="background: #c53030; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-family: monospace; font-size: 1.2rem;">RESTORE</span> ä»¥ç¡®è®¤æ¢å¤:
                            </label>
                            <input type="text" class="form-control confirm-input" id="restoreConfirmInput" 
                                   placeholder="è¾“å…¥ RESTOREï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰" autocomplete="off">
                            <small class="form-text" style="color: #c53030; font-weight: 500;">
                                <i class="fas fa-info-circle me-1"></i>å¿…é¡»å®Œå…¨åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™
                            </small>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); border-left: 4px solid #fc8181; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                            <p class="mb-0" style="color: #742a2a; font-weight: 500;">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>å»ºè®®:</strong> åœ¨æ‰§è¡Œæ¢å¤æ“ä½œå‰ï¼Œè¯·ç¡®ä¿å·²åˆ›å»ºå½“å‰æ•°æ®åº“çš„å¤‡ä»½ã€‚
                            </p>
                        </div>
                    </div>
                    <div class="modal-footer" style="background: #fff5f5;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-ban me-1"></i>å–æ¶ˆæ“ä½œ
                        </button>
                        <button type="button" class="btn btn-danger" onclick="executeRestore('${filename}')" style="font-weight: 700; padding: 0.6rem 2rem;">
                            <i class="fas fa-exclamation-triangle me-1"></i>ç¡®è®¤æ¢å¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const oldModal = document.getElementById('restoreConfirmModal');
    if (oldModal) oldModal.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('restoreConfirmModal'));
    modal.show();
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    document.getElementById('restoreConfirmInput').focus();
}

// æ‰§è¡Œæ•°æ®åº“æ¢å¤
function executeRestore(filename) {
    const confirmInput = document.getElementById('restoreConfirmInput');
    const confirmCode = confirmInput.value.trim();
    
    if (confirmCode !== 'RESTORE') {
        showCenterMessage('âŒ ç¡®è®¤ç é”™è¯¯ï¼Œè¯·è¾“å…¥"RESTORE"', 'error');
        confirmInput.focus();
        confirmInput.select();
        return;
    }
    
    // å…³é—­ç¡®è®¤æ¨¡æ€æ¡†
    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('restoreConfirmModal'));
    if (confirmModal) {
        confirmModal.hide();
    }
    
    // æ˜¾ç¤ºæ¢å¤è¿›åº¦
    showCenterMessage('â³ æ­£åœ¨æ¢å¤æ•°æ®åº“ï¼Œè¯·è€å¿ƒç­‰å¾…...\næ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ', 'info');
    
    fetch('/api/admin/maintenance/restore', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            filename: filename,
            confirm_code: confirmCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showCenterMessage('âœ… ' + data.message + '\n\né¡µé¢å°†åœ¨3ç§’ååˆ·æ–°...', 'success');
            
            // 3ç§’ååˆ·æ–°é¡µé¢
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            showCenterMessage('âŒ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('æ¢å¤å¤±è´¥:', error);
        showCenterMessage('âŒ æ¢å¤å¤±è´¥: ' + error, 'error');
    });
}

// åˆ‡æ¢ç³»ç»Ÿç»´æŠ¤æ¨¡å¼
function toggleMaintenanceMode() {
    // è·å–å½“å‰æŒ‰é’®çŠ¶æ€
    const btn = document.getElementById('maintenanceModeBtn');
    const btnText = document.getElementById('maintenanceBtnText');
    const statusText = document.getElementById('maintenanceStatusText');
    
    // å…ˆç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    btn.disabled = true;
    
    // è°ƒç”¨APIåˆ‡æ¢ç»´æŠ¤æ¨¡å¼
    fetch('/api/admin/maintenance/mode/toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›´æ–°æŒ‰é’®å’ŒçŠ¶æ€æ˜¾ç¤º
            if (data.maintenance_mode) {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
                btnText.textContent = 'ç»“æŸç³»ç»Ÿç»´æŠ¤';
                statusText.textContent = 'ç»´æŠ¤æ¨¡å¼';
                statusText.parentElement.classList.remove('text-muted');
                statusText.parentElement.classList.add('text-warning');
                showCenterMessage('âœ… ' + data.message, 'success');
            } else {
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
                btnText.textContent = 'è¿›è¡Œç³»ç»Ÿç»´æŠ¤';
                statusText.textContent = 'æ­£å¸¸è¿è¡Œ';
                statusText.parentElement.classList.remove('text-warning');
                statusText.parentElement.classList.add('text-muted');
                showCenterMessage('âœ… ' + data.message, 'success');
            }
        } else {
            showCenterMessage('âŒ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('åˆ‡æ¢ç»´æŠ¤æ¨¡å¼å¤±è´¥:', error);
        showCenterMessage('âŒ åˆ‡æ¢ç»´æŠ¤æ¨¡å¼å¤±è´¥', 'error');
    })
    .finally(() => {
        // é‡æ–°å¯ç”¨æŒ‰é’®
        btn.disabled = false;
    });
}

// é¡µé¢åŠ è½½æ—¶è·å–å½“å‰ç»´æŠ¤æ¨¡å¼çŠ¶æ€
function loadMaintenanceStatus() {
    fetch('/api/admin/maintenance/mode')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById('maintenanceModeBtn');
            const btnText = document.getElementById('maintenanceBtnText');
            const statusText = document.getElementById('maintenanceStatusText');
            
            if (btn && btnText && statusText) {
                if (data.maintenance_mode) {
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                    btnText.textContent = 'ç»“æŸç³»ç»Ÿç»´æŠ¤';
                    statusText.textContent = 'ç»´æŠ¤æ¨¡å¼';
                    statusText.parentElement.classList.remove('text-muted');
                    statusText.parentElement.classList.add('text-warning');
                } else {
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-warning');
                    btnText.textContent = 'è¿›è¡Œç³»ç»Ÿç»´æŠ¤';
                    statusText.textContent = 'æ­£å¸¸è¿è¡Œ';
                    statusText.parentElement.classList.remove('text-warning');
                    statusText.parentElement.classList.add('text-muted');
                }
            }
        }
    })
    .catch(error => {
        console.error('è·å–ç»´æŠ¤æ¨¡å¼çŠ¶æ€å¤±è´¥:', error);
    });
}

// ==================== ç¾åŒ–æ¨¡æ€æ¡†æ ·å¼ ====================
// åœ¨é¡µé¢åŠ è½½æ—¶æ·»åŠ è‡ªå®šä¹‰æ ·å¼
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½ç»´æŠ¤æ¨¡å¼çŠ¶æ€
    loadMaintenanceStatus();
    const style = document.createElement('style');
    style.textContent = `
        /* æ¨¡æ€æ¡†ç¾åŒ–æ ·å¼ */
        .maintenance-modal .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .maintenance-modal .modal-header {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
            color: white;
            border: none;
            padding: 1.5rem 2rem;
        }
        
        .maintenance-modal .modal-header.stats-header {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
        }
        
        .maintenance-modal .modal-header.logs-header {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
        }
        
        .maintenance-modal .modal-header.health-header {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
        }
        
        .maintenance-modal .modal-header.backup-header {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
        }
        
        .maintenance-modal .modal-header.danger-header {
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
        }
        
        .maintenance-modal .modal-title {
            font-weight: 600;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .maintenance-modal .modal-title i {
            font-size: 1.8rem;
            margin-right: 12px;
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .maintenance-modal .modal-body {
            padding: 2rem;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        }
        
        .maintenance-modal .modal-footer {
            border: none;
            padding: 1.5rem 2rem;
            background: #f8f9fa;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ç¾åŒ– */
        .stats-card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }
        
        .stats-card.db-size {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
        }
        
        .stats-card.participants {
            background: linear-gradient(135deg, #AED6F1 0%, #7FB3D5 100%);
        }
        
        .stats-card .card-body {
            padding: 2rem;
            text-align: center;
            color: white;
        }
        
        .stats-card h2 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .stats-card p {
            font-size: 1.1rem;
            opacity: 0.95;
            margin: 0;
        }
        
        /* ç»Ÿè®¡åˆ—è¡¨ç¾åŒ– */
        .stats-list {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .stats-list h6 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .stats-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .stats-list li {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, #f8f9fa, white);
            border-radius: 8px;
            border-left: 4px solid #5DADE2;
            transition: all 0.3s ease;
        }
        
        .stats-list li:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* æ—¥å¿—è¡¨æ ¼ç¾åŒ– */
        .logs-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .logs-table thead {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
            color: white;
        }
        
        .logs-table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            border: none;
        }
        
        .logs-table tbody tr {
            transition: all 0.3s ease;
        }
        
        .logs-table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }
        
        .logs-table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .logs-table .badge {
            padding: 0.4rem 0.8rem;
            font-weight: 600;
            border-radius: 20px;
        }
        
        /* å¥åº·æ£€æŸ¥å¡ç‰‡ç¾åŒ– */
        .health-check-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }
        
        .health-check-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .health-check-card.healthy {
            border-left-color: #48bb78;
        }
        
        .health-check-card.warning {
            border-left-color: #ed8936;
        }
        
        .health-check-card.error {
            border-left-color: #f56565;
        }
        
        .health-check-card h6 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .health-check-card h6 i {
            margin-right: 0.75rem;
            font-size: 1.5rem;
        }
        
        .health-status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        /* å¤‡ä»½åˆ—è¡¨ç¾åŒ– */
        .backup-search {
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .backup-search:focus {
            border-color: #5DADE2;
            box-shadow: 0 0 0 3px rgba(93, 173, 226, 0.1);
            outline: none;
        }
        
        .backup-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .backup-table thead {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
            color: white;
        }
        
        .backup-table thead th {
            font-weight: 600;
            padding: 1rem;
            border: none;
        }
        
        .backup-table tbody tr {
            transition: all 0.3s ease;
        }
        
        .backup-table tbody tr:hover {
            background: #fef5e7;
        }
        
        .backup-table .btn-sm {
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .backup-table .btn-sm:hover {
            transform: scale(1.1);
        }
        
        /* æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†ç¾åŒ– */
        .restore-warning {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .restore-warning h6 {
            color: #c53030;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .restore-warning h6 i {
            margin-right: 0.75rem;
            font-size: 1.5rem;
            animation: warningPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes warningPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .restore-warning ul {
            color: #742a2a;
            font-weight: 500;
            margin: 0;
        }
        
        .restore-warning li {
            margin-bottom: 0.5rem;
        }
        
        .confirm-input {
            border: 3px solid #fc8181;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .confirm-input:focus {
            border-color: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.2);
            outline: none;
        }
        
        /* æŒ‰é’®ç¾åŒ– */
        .maintenance-modal .btn {
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .maintenance-modal .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .maintenance-modal .btn-primary {
            background: linear-gradient(135deg, #89CFF0 0%, #5DADE2 100%);
        }
        
        .maintenance-modal .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .maintenance-modal .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .maintenance-modal.show .modal-dialog {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        /* ä¿¡æ¯æç¤ºç¾åŒ– */
        .info-alert {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            border: none;
            border-left: 5px solid #0097a7;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .info-alert i {
            font-size: 1.2rem;
            color: #00838f;
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}
