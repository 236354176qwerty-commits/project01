{% extends "base.html" %}

{% block title %}注册 - 武术赛事管理系统{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/login.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-card card shadow-lg border-0 single-column">
        <div class="row g-0">
            <!-- Single-column: Register form only -->
            <div class="col-12">
                <div class="card-body p-4">
                    <!-- Logo和标题 -->
                    <div class="text-center mb-4">
                        <div class="login-logo mb-3">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <h2 class="card-title mb-2">用户注册</h2>
                        <p class="text-muted">武术赛事管理系统</p>
                    </div>

                    <!-- 注册表单 -->
                    <form id="registerForm">
                        <!-- 第一行：账号 + 用户昵称 -->
                        <div class="row gy-3 gx-5">
                            <div class="col-md-6 field-narrow">
                                <label for="username" class="form-label text-center w-100">
                                    <i class="fas fa-user me-2"></i>账号
                                </label>
                                <input type="text" class="form-control form-control-lg" id="username" 
                                       placeholder="请输入账号（0~12个字符，不能包含汉字）" minlength="1" maxlength="12" pattern="^[A-Za-z0-9_\-\.]{1,12}$">
                            </div>
                            <div class="col-md-6 field-narrow">
                                <label for="nickname" class="form-label text-center w-100">
                                    <i class="fas fa-id-card me-2"></i>用户昵称
                                </label>
                                <input type="text" class="form-control form-control-lg" id="nickname" 
                                       placeholder="请输入用户昵称（2~20个字符）" minlength="2" maxlength="20">
                            </div>
                        </div>

                        <!-- 第二行：密码 + 确认密码 -->
                        <div class="row gy-3 gx-5 mt-2">
                            <div class="col-md-6 field-narrow">
                                <label for="password" class="form-label text-center w-100">
                                    <i class="fas fa-lock me-2"></i>密码
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control form-control-lg" id="password" 
                                           placeholder="6-20个字符，包含数字和小写字母" minlength="6" maxlength="20">
                                    <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 field-narrow">
                                <label for="confirmPassword" class="form-label text-center w-100">
                                    <i class="fas fa-lock-open me-2"></i>确认密码
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control form-control-lg" id="confirmPassword" 
                                           placeholder="再次输入密码">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 第三行：手机号 + 验证码 -->
                        <div class="row gy-3 gx-5 mt-2">
                            <div class="col-md-6 field-narrow">
                                <label for="phone" class="form-label text-center w-100">
                                    <i class="fas fa-mobile-alt me-2"></i>手机号
                                </label>
                                <input type="tel" class="form-control form-control-lg" id="phone" 
                                       placeholder="请输入11位手机号" pattern="[0-9]{11}" maxlength="11">
                            </div>
                            <div class="col-md-6 field-narrow">
                                <label for="captcha" class="form-label text-center w-100">
                                    <i class="fas fa-shield-alt me-2"></i>验证码
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-lg" id="captcha" 
                                           placeholder="请输入验证码" maxlength="4">
                                    <img id="captchaImage" src="/api/auth/captcha" alt="验证码" 
                                         class="captcha-image" onclick="refreshCaptcha()" 
                                         title="点击刷新验证码">
                                </div>
                            </div>
                        </div>

                        <div class="form-check mt-3 mb-3">
                            <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                我已阅读并同意 <a href="#" class="text-decoration-none">用户协议</a> 和 
                                <a href="#" class="text-decoration-none">隐私政策</a>
                            </label>
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" class="btn btn-primary btn-lg" id="registerBtn">
                                <i class="fas fa-user-plus me-2"></i>注册
                            </button>
                        </div>
                    </form>
                    
                    <!-- 登录链接 -->
                    <div class="text-center">
                        <p class="mb-2">已有账户？</p>
                        <a href="{{ url_for('login') }}" class="btn btn-outline-primary">
                            <i class="fas fa-sign-in-alt me-2"></i>立即登录
                        </a>
                    </div>
                </div>
            </div>

            <!-- 系统信息 -->
            <div class="text-center mt-4">
                <p class="text-muted small">
                    <i class="fas fa-shield-alt me-1"></i>
                    安全注册 | 数据加密传输
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 短信验证码模态框 -->
<div class="modal fade" id="smsVerificationModal" tabindex="-1" data-bs-backdrop="false" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; padding: 20px;">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body text-center px-4 pb-4">
                <h4 class="mb-3" style="font-weight: 600; color: #2c3e50;">验证手机号</h4>
                <p class="text-muted mb-4">
                    验证码已发送至手机号<br>
                    <strong id="displayPhone" style="color: #2c3e50; font-size: 1.1rem;"></strong>
                </p>
                
                <!-- 6位验证码输入框 -->
                <div class="d-flex justify-content-center gap-2 mb-4" id="smsCodeInputs">
                    <input type="text" class="form-control text-center sms-code-input" maxlength="1" inputmode="numeric" data-index="0" style="width: 50px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 10px;">
                    <input type="text" class="form-control text-center sms-code-input" maxlength="1" inputmode="numeric" data-index="1" style="width: 50px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 10px;">
                    <input type="text" class="form-control text-center sms-code-input" maxlength="1" inputmode="numeric" data-index="2" style="width: 50px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 10px;">
                    <input type="text" class="form-control text-center sms-code-input" maxlength="1" inputmode="numeric" data-index="3" style="width: 50px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 10px;">
                    <input type="text" class="form-control text-center sms-code-input" maxlength="1" inputmode="numeric" data-index="4" style="width: 50px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 10px;">
                    <input type="text" class="form-control text-center sms-code-input" maxlength="1" inputmode="numeric" data-index="5" style="width: 50px; height: 60px; font-size: 24px; font-weight: bold; border-radius: 10px;">
                </div>
                <input type="hidden" id="smsVerificationCode">
                
                <button type="button" class="btn btn-primary btn-lg w-100 mb-3" id="confirmSmsBtn" style="border-radius: 12px; height: 50px; font-size: 16px; font-weight: 600;" disabled>
                    确认注册
                </button>
                
                <p class="text-muted small mb-2">
                    没有收到验证码？
                    <a href="javascript:void(0)" id="resendSmsLink" class="text-primary" onclick="resendSmsCode()">重新发送</a>
                </p>
                <p class="text-muted small">
                    如未收到请查看垃圾短信或稍后重试
                </p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 存储待注册的用户数据
let pendingRegistrationData = null;

$(document).ready(function() {
    // 检查是否已登录
    checkLoginStatus();
    
    // 初始化短信验证码输入框
    initSmsCodeInputs();
    
    // 注册表单提交
    $('#registerForm').on('submit', function(e) {
        e.preventDefault();
        submitRegister();
    });
    
    // 确认短信验证码按钮
    $('#confirmSmsBtn').on('click', function() {
        confirmSmsVerification();
    });
    
    // 密码显示/隐藏切换
    $('#togglePassword').on('click', function() {
        togglePasswordVisibility('password', $(this));
    });
    
    $('#toggleConfirmPassword').on('click', function() {
        togglePasswordVisibility('confirmPassword', $(this));
    });
    
    // 密码确认验证
    $('#confirmPassword').on('input', function() {
        validatePasswordMatch();
    });
    
    $('#password').on('input', function() {
        validatePasswordMatch();
    });

    // 用户名校验：禁止汉字，并进行唯一性检查
    $('#username').on('blur', function() {
        const username = $(this).val().trim();
        const chineseRegex = /[\u4e00-\u9fa5]/;
        if (chineseRegex.test(username)) {
            this.setCustomValidity('账号不能包含汉字');
            $(this).addClass('is-invalid');
            showMessage('账号不能包含汉字', 'error');
            return;
        } else {
            this.setCustomValidity('');
            $(this).removeClass('is-invalid');
        }
        if (username.length >= 1) {
            $.get('/api/check_username', { username: username })
                .done(function(resp) {
                    if (resp.success && resp.available === false) {
                        $('#username')[0].setCustomValidity('该账号已存在，请更换其他账号');
                        $('#username').addClass('is-invalid');
                        showMessage('该账号已存在，请更换其他账号', 'warning');
                    } else {
                        $('#username')[0].setCustomValidity('');
                        $('#username').removeClass('is-invalid').addClass('is-valid');
                    }
                })
                .fail(function() {
                    // 忽略网络错误，交由提交时由后端再次校验
                });
        }
    });
    
    // 输入框焦点事件
    $('.form-control').on('focus', function() {
        $(this).addClass('is-focused');
    }).on('blur', function() {
        $(this).removeClass('is-focused');
    });
});

function checkLoginStatus() {
    // 检查服务器端session状态
    $.ajax({
        url: '/api/check_login',
        method: 'GET',
        success: function(response) {
            if (response.logged_in) {
                window.location.href = '/dashboard';
            }
        },
        error: function() {
            // 忽略错误，继续显示注册页面
        }
    });
}

function togglePasswordVisibility(fieldId, button) {
    const passwordField = $('#' + fieldId);
    const icon = button.find('i');
    
    if (passwordField.attr('type') === 'password') {
        passwordField.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        passwordField.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

function validatePasswordMatch() {
    const password = $('#password').val();
    const confirmPassword = $('#confirmPassword').val();
    
    if (password && confirmPassword && password !== confirmPassword) {
        $('#confirmPassword')[0].setCustomValidity('两次输入的密码不一致');
        $('#confirmPassword').addClass('is-invalid');
    } else {
        $('#confirmPassword')[0].setCustomValidity('');
        $('#confirmPassword').removeClass('is-invalid');
    }
}

function submitRegister() {
    // 手动验证而不是使用浏览器默认验证
    const username = $('#username').val().trim();
    const nickname = $('#nickname').val().trim();
    const password = $('#password').val();
    const confirmPassword = $('#confirmPassword').val();
    const phone = $('#phone').val().trim();
    const captcha = $('#captcha').val().trim();
    
    // 检查必填字段
    if (!username) {
        showMessage('请输入账号', 'error');
        $('#username').focus();
        return;
    }
    if (!nickname) {
        showMessage('请输入用户昵称', 'error');
        $('#nickname').focus();
        return;
    }
    if (!password) {
        showMessage('请输入密码', 'error');
        $('#password').focus();
        return;
    }
    if (!confirmPassword) {
        showMessage('请确认密码', 'error');
        $('#confirmPassword').focus();
        return;
    }
    if (!phone) {
        showMessage('请输入手机号', 'error');
        $('#phone').focus();
        return;
    }
    if (!captcha) {
        showMessage('请输入验证码', 'error');
        $('#captcha').focus();
        return;
    }
    
    // 验证账号格式
    if (username.length > 12) {
        showMessage('账号最多12个字符', 'error');
        return;
    }
    if (/[^\x00-\x7F]/.test(username) || /[\u4e00-\u9fa5]/.test(username)) {
        showMessage('账号不能包含汉字', 'error');
        return;
    }
    
    // 验证用户昵称（2~20个字符，不能包含敏感词汇）
    if (nickname.length < 2 || nickname.length > 20) {
        showMessage('用户昵称必须为2~20个字符', 'error');
        return;
    }
    
    const sensitiveWords = ['政治', '暴力', '色情', '赌博', '毒品', '反动', '邪教'];
    for (let word of sensitiveWords) {
        if (nickname.includes(word)) {
            showMessage('用户昵称包含敏感词汇，请重新输入', 'error');
            return;
        }
    }
    
    // 验证密码（6-20个字符，至少包含数字和小写字母，不能包含汉字）
    if (password.length < 6 || password.length > 20) {
        showMessage('密码必须为6-20个字符', 'error');
        return;
    }
    
    const hasNumber = /\d/.test(password);
    const hasLowercase = /[a-z]/.test(password);
    const hasChinese = /[\u4e00-\u9fa5]/.test(password);
    
    if (!hasNumber || !hasLowercase) {
        showMessage('密码必须同时包含数字和小写字母', 'error');
        return;
    }
    
    if (hasChinese) {
        showMessage('密码不能包含汉字', 'error');
        return;
    }
    
    // 验证确认密码
    if (password !== confirmPassword) {
        showMessage('两次输入的密码不一致', 'error');
        return;
    }
    
    // 验证验证码
    if (captcha.length !== 4) {
        showMessage('请输入4位验证码', 'error');
        return;
    }
    
    // 验证手机号（必须11位数字）
    const phoneRegex = /^[0-9]{11}$/;
    if (!phoneRegex.test(phone)) {
        showMessage('手机号必须为11位数字', 'error');
        return;
    }
    
    // 保存待注册数据
    pendingRegistrationData = {
        username: username,
        nickname: nickname,
        password: password,
        confirmPassword: confirmPassword,
        phone: phone,
        captcha: captcha
    };
    
    // 发送短信验证码
    const registerBtn = $('#registerBtn');
    const originalText = registerBtn.html();
    registerBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>发送验证码...');
    
    $.ajax({
        url: '/api/auth/send-verification-code',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ 
            phone: phone,
            purpose: 'register'  // 标记为注册用途
        }),
        success: function(response) {
            registerBtn.prop('disabled', false).html(originalText);
            
            if (response.success) {
                // 显示手机号（隐藏中间4位）
                const maskedPhone = phone.substring(0, 3) + '****' + phone.substring(7);
                $('#displayPhone').text(maskedPhone);
                
                // 清空验证码输入框
                $('.sms-code-input').val('');
                $('#smsVerificationCode').val('');
                $('#confirmSmsBtn').prop('disabled', true);
                
                // 弹出短信验证码模态框
                $('#smsVerificationModal').modal('show');
                
                // 自动聚焦第一个输入框
                setTimeout(() => {
                    $('.sms-code-input').first().focus();
                }, 500);
                
                showMessage('验证码已发送至您的手机', 'success');
                
                // 演示模式：在控制台显示验证码
                if (response.code) {
                    console.log('【演示模式】短信验证码：' + response.code);
                }
            } else {
                showMessage(response.message || '发送验证码失败', 'error');
                if (response.message && response.message.includes('验证码')) {
                    refreshCaptcha();
                }
            }
        },
        error: function(xhr) {
            registerBtn.prop('disabled', false).html(originalText);
            const response = xhr.responseJSON;
            const message = response && response.message ? response.message : '发送验证码失败，请稍后重试';
            showMessage(message, 'error');
        }
    });
}

function refreshCaptcha() {
    // 刷新验证码图片
    const captchaImage = $('#captchaImage');
    const timestamp = new Date().getTime();
    captchaImage.attr('src', '/api/auth/captcha?t=' + timestamp);
}

// 初始化短信验证码输入框
function initSmsCodeInputs() {
    const inputs = document.querySelectorAll('.sms-code-input');
    
    inputs.forEach((input, index) => {
        // 输入事件
        input.addEventListener('input', function(e) {
            // 只允许数字
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // 如果输入了值，自动跳到下一个框
            if (this.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            // 更新隐藏的验证码字段
            updateSmsVerificationCode();
        });
        
        // 键盘事件
        input.addEventListener('keydown', function(e) {
            // 退格键：如果当前框为空，跳到前一个框
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                inputs[index - 1].focus();
            }
            
            // 左箭头键：跳到前一个框
            if (e.key === 'ArrowLeft' && index > 0) {
                inputs[index - 1].focus();
            }
            
            // 右箭头键：跳到下一个框
            if (e.key === 'ArrowRight' && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
        
        // 粘贴事件：自动分配到各个框
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
            
            // 分配粘贴的数字到各个框
            for (let i = 0; i < Math.min(pastedData.length, inputs.length - index); i++) {
                inputs[index + i].value = pastedData[i];
            }
            
            // 更新隐藏的验证码字段
            updateSmsVerificationCode();
            
            // 聚焦到下一个空框或最后一个框
            const nextEmptyIndex = Array.from(inputs).findIndex((inp, idx) => idx >= index && inp.value === '');
            if (nextEmptyIndex !== -1) {
                inputs[nextEmptyIndex].focus();
            } else {
                inputs[inputs.length - 1].focus();
            }
        });
        
        // 聚焦事件：选中当前内容
        input.addEventListener('focus', function() {
            this.select();
        });
    });
}

// 更新短信验证码隐藏字段
function updateSmsVerificationCode() {
    const inputs = document.querySelectorAll('.sms-code-input');
    let code = '';
    inputs.forEach(input => {
        code += input.value;
    });
    document.getElementById('smsVerificationCode').value = code;
    
    // 启用/禁用确认按钮
    const confirmBtn = document.getElementById('confirmSmsBtn');
    if (code.length === 6) {
        confirmBtn.disabled = false;
    } else {
        confirmBtn.disabled = true;
    }
}

// 确认短信验证码并提交注册
function confirmSmsVerification() {
    const smsCode = $('#smsVerificationCode').val();
    
    if (!smsCode || smsCode.length !== 6) {
        showMessage('请输入6位验证码', 'warning');
        return;
    }
    
    if (!pendingRegistrationData) {
        showMessage('注册数据丢失，请重新注册', 'error');
        $('#smsVerificationModal').modal('hide');
        return;
    }
    
    const confirmBtn = $('#confirmSmsBtn');
    const originalText = confirmBtn.html();
    confirmBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>注册中...');
    
    // 提交注册请求
    $.ajax({
        url: '/api/auth/register',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            username: pendingRegistrationData.username,
            nickname: pendingRegistrationData.nickname,
            password: pendingRegistrationData.password,
            confirmPassword: pendingRegistrationData.confirmPassword,
            phone: pendingRegistrationData.phone,
            captcha: pendingRegistrationData.captcha,
            sms_code: smsCode  // 添加短信验证码
        }),
        success: function(response) {
            if (response.success) {
                showMessage('注册成功！即将跳转到登录页面', 'success');
                $('#smsVerificationModal').modal('hide');
                setTimeout(function() {
                    window.location.href = '/login';
                }, 2000);
            } else {
                showMessage(response.message, 'error');
                confirmBtn.prop('disabled', false).html(originalText);
                
                // 如果是验证码错误，清空输入
                if (response.message.includes('验证码')) {
                    $('.sms-code-input').val('');
                    $('#smsVerificationCode').val('');
                    $('.sms-code-input').first().focus();
                }
            }
        },
        error: function(xhr) {
            confirmBtn.prop('disabled', false).html(originalText);
            const response = xhr.responseJSON;
            const message = response && response.message ? response.message : '注册失败，请稍后重试';
            showMessage(message, 'error');
        }
    });
}

// 重新发送短信验证码
function resendSmsCode() {
    if (!pendingRegistrationData || !pendingRegistrationData.phone) {
        showMessage('请重新填写注册信息', 'error');
        $('#smsVerificationModal').modal('hide');
        return;
    }
    
    const resendLink = $('#resendSmsLink');
    resendLink.css('pointer-events', 'none').css('color', '#999');
    
    $.ajax({
        url: '/api/auth/send-verification-code',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ 
            phone: pendingRegistrationData.phone,
            purpose: 'register'  // 标记为注册用途
        }),
        success: function(response) {
            if (response.success) {
                showMessage('验证码已重新发送', 'success');
                
                // 清空输入框
                $('.sms-code-input').val('');
                $('#smsVerificationCode').val('');
                $('.sms-code-input').first().focus();
                
                // 30秒后才能再次发送
                let countdown = 30;
                const timer = setInterval(() => {
                    countdown--;
                    resendLink.text(`${countdown}秒后重新发送`);
                    if (countdown <= 0) {
                        clearInterval(timer);
                        resendLink.text('重新发送').css('pointer-events', 'auto').css('color', '');
                    }
                }, 1000);
                
                // 演示模式：在控制台显示验证码
                if (response.code) {
                    console.log('【演示模式】短信验证码：' + response.code);
                }
            } else {
                showMessage(response.message || '发送失败', 'error');
                resendLink.css('pointer-events', 'auto').css('color', '');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            const message = response && response.message ? response.message : '发送失败，请稍后重试';
            showMessage(message, 'error');
            resendLink.css('pointer-events', 'auto').css('color', '');
        }
    });
}
</script>

<style>
.captcha-image {
    width: 120px;
    height: 48px;
    border: 1px solid #ced4da;
    border-left: 0;
    border-radius: 0 0.375rem 0.375rem 0;
    cursor: pointer;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    letter-spacing: 2px;
    user-select: none;
}

.captcha-image:hover {
    background-color: #e9ecef;
}
</style>
{% endblock %}